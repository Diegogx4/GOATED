

Credential harvesting consists of techniques for accessing, identifying, and stealing user account names and/or passwords. Credential harvesting uses multiple ways to obtain sensitive material including the classic email phishing, which typically offers links to false websites or malicious attachments. Attackers often utilize different social engineering techniques, digital scamming, and malware to steal credentials. Specific Tactics, Techniques, and Procedures (TTP) that are often utilized during credential harvesting campaigns are discussed, followed by a detailed review of analysis, detection, and defense strategies that can be employed by a Cyber Defense Analyst (CDA). Finally, trainees are tasked to use their newly-gained knowledge to employ a Group Policy Object (GPO) on the domain. 

Introduction to Credential Harvesting


Credentials are used to access devices and systems on a given network. Credentials include user account names and passwords. According to MITRE ATT&CK Tactic Credential Access (TA0006), harvesting credentials consists of techniques for accessing, identifying, and stealing user account names and/or passwords. Techniques used to obtain credentials include keylogging, Man-in-the-Middle (MITM) attacks, phishing, and credential dumping. Specific techniques are detailed later in this lesson. The use of legitimate credentials gives adversaries access to systems, making them harder to detect, and provides the opportunity to create more accounts to help achieve their goals. 

Credential harvesting is a tactic in the Enterprise Framework from MITRE ATT&CK, as shown in Figure 6.1-1:

Credential harvesting is also included in the reconnaissance phase of the MITRE ATT&CK Framework. According to MITRE ATT&CK, "the reconnaissance phase consists of techniques used and data that adversaries gather that can be leveraged to aid or help coordinate future campaigns or attacks, which likely occur later within the MITRE ATT&CK Framework. The data collected during the reconnaissance phase can be collected in an active or passive manner and information may include data points related to target systems, users, architecture, devices, or infrastructure."
﻿
Active data collection occurs when the adversary has infiltrated the target network in an attempt to identify and leverage any vulnerabilities and collect information available. Comparatively, passive data collection is not as infiltrated in the target network. Passive data collection occurs when the adversary is not actively manipulating or searching on the target network, rather, the adversary may be listening or watching traffic.

Credential Harvesting Techniques 
Brute Force Attacks and Credential Harvesting
﻿
Credential harvesting is categorized under the MITRE ATT&CK technique for brute force attacks (T1110). Brute force attacks include techniques that can be used when the password portion of credential information is not known. Brute force includes the following sub-techniques:

Additional Credential Harvesting Techniques

Multiple credential harvesting techniques exist that do not fall under the brute force attack techniques. Below are the techniques:

Defenses Against Credential Harvesting
The primary defense against credential harvesting is strong password management. Enforcing all password settings ensures that passwords are complex, changed frequently, and require two-factor authentication. Below are three strategies that should be implemented to prevent credential harvesting:

Harvesting Credentials by Password Spraying | Part 1
﻿

﻿

Walk through the MITRE ATT&CK technique of password spraying, as seen from an adversarial perspective. A small dump of credentials was obtained through a successful phishing attack. Using the information from the dump, a small password spraying attack is conducted in an attempt to access the network. 

2. Right-click the Windows icon, and select Run. In the Open: textbox, enter PowerShell, and select OK:

3. Navigate to and access the Sample-Dump.txt file using the following cmdlet:

PS C:\Users\trainee.vcch> Get-Content C:\Users\trainee.vcch\Sample-Dump.txt
﻿

The output from the cmdlet returns eight passwords and six usernames.

Which file path leads to the domain's GPOs?
Forest: vcch.lan > Domains > vcch.lan > Group Policy Objects



Host identification and scanning typically occur early on in the MITRE ATT&CK lifecycle and occur continuously during an attack campaign as the adversary continues to expand access. The purpose of host discovery is to figure out which hosts are accessible over the network. Some protocols a Cyber Defense Analyst (CDA) might encounter during host discovery are Address Resolution Protocol (ARP), Internet Control Message Protocol (ICMP), Domain Name System (DNS), and Transmission Control Protocol (TCP)/User Datagram Protocol (UDP) pings.


After the host is verified as accessible, the adversary proceeds to port scan the host(s). Port scanning is done to check which services are up and running. Upon receiving port scan results, the adversary can determine the host's purpose in the network (e.g., is it a web server, mail server). Recall that this is because port numbers typically correspond to specific services.


After the adversary gathers a list of open ports, and thus a list of services running on the host, they would proceed to conduct vulnerability scanning. Vulnerability scanning probes a service — or many services — and attempts to discover any weaknesses in configuration. Once the adversary discovers a vulnerability they can leverage, they launch an exploit, gaining access into their target system.


These are not hard and fast rules, and these actions do not have to occur sequentially or together at all. However, this sequence provides a logical progression on the avenues an adversary may take to gaining the requisite information in selecting the appropriate exploit. Knowing how the adversary functions enables a CDA to take opposing mitigating actions.

Port Scanning

Port scanning is the technique of scanning hosts on a network for running services. The MITRE ATT&CK technique identifier for port scanning, known as network service scanning to MITRE, is T1049. Port scanning may or may not be preceded by host discovery.

﻿

Port scanning leverages two transport layer protocols:

Transmission Control Protocol (TCP)

User Datagram Protocol (UDP)

You should be familiar with these protocols from previous courses. It is more common to rely on TCP to conduct a port scan as UDP scans do not always return definitive results detailing if a port is open.

﻿

TCP Port Scan
TCP is a connection-orientated protocol — it relies on a three-way handshake to establish a connection. Recall that the client initiating the connection sends a packet with the Synchronize (SYN) flag set. The receiving server replies with a packet including the SYN/Acknowledge (ACK) flags, to which the client responds with a packet including the ACK flag set. This sequence establishes the connection. There are a few exceptions to this rule, such as Hypertext Transfer Protocol (HTTP) FAST GET, which sends data with the SYN packet, but these instances are outside the scope of this lesson. Port scanners exploit the requirement of the three-way handshake to determine if a port is open. If the client receives a SYN/ACK from the server, then this is all the information needed to surmise that the port is open. If a packet with a Reset (RST) flag is received, then the port is closed. If there is no response from the server, then port filtering is likely occurring somewhere in the network or on the server host, and the client is unable to determine if the port is open.

UDP Port Scan
UDP is not connection-orientated. Packets are simply assigned an Internet Protocol (IP) and a port number and shipped off. There is no built-in mechanism in UDP that determines if the packet made it. The simplicity in UDP serves as a disadvantage while port scanning. If a response is received from the server, then you can definitively say that the UDP port is open. However, sending UDP packets at a host often returns no data if the port is open. This response would be no different if the port was filtered. If the port is closed, then an ICMP Port Unreachable message may be received, which can be generated by the server host or gateway. Other ICMP messages mean that the port is filtered.

Port Scanning Utilities
Netcat
﻿

Often called the TCP/IP Swiss Army knife, Netcat is a versatile tool that can be used for purposes such as a chat/messaging server, file transferrer, and, of course, port scanner. Netcat has a very small footprint and comes pre-installed on most Linux distributions and is easily installed on Windows. The preinstalled version of Netcat on several Linux versions is often different from the one you can build from source code. A common modification is the removal of the ability to execute programs due to the security implications; namely being able to remotely gain a shell. Figure 6.2-3 shows the help menu presented by Netcat.

﻿

﻿

Figure 6.2-3

﻿

Telnet
﻿

Telnet is a protocol that allows remote logins to another system running a Telnet server. You should already be familiar with the security implications of using Telnet for remote administration; however, the Telnet client is still useful for port scanning and banner grabbing. The client comes preinstalled on several versions of Cisco Internetwork Operating System (IOS) and other routing Operating Systems (OS). Figure 6.2-4 shows usage options for Telnet.

﻿

﻿

Figure 6.2-4

﻿

Use Netcat and Telnet to experiment with port scanning.

﻿

Workflow

﻿

1. Log in to the kali-hunt Virtual Machine (VM) using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

2. Netcat comes on several distributions, but it may not always be installed on yours. Open a terminal window and run the following command to verify that Netcat is installed on the machine:

(trainee@dmss-kali)-[~] $ which nc
﻿

﻿

Figure 6.2-5

﻿

Netcat is present on the system and located in /usr/bin/nc.

﻿

3. Run the following command to view the available options available for the utility:

(trainee@dmss-kali)-[~] $ nc -h
﻿

﻿

Figure 6.2-6

﻿

The options used in the next step are -n, -v, and -w.

﻿

4. Run the following command to scan a host in the range's DMZ network:

(trainee@dmss-kali)-[~] $ nc -nvw 10 172.35.3.6 80
﻿

The complete command is explained as follows:

-n: Do not perform any lookups of addresses, hostnames, or ports

-v: Increase verbosity

-w: Set a timeout. In this case, Netcat waits 10 seconds before giving up attempting to establish a connection.

The host being scanned is 172.35.3.6, whose primary function is as a web server.

﻿

The port being scanned is 80 or HTTP.

﻿

﻿

Figure 6.2-7

﻿

Notice that upon connection, the client hangs. At this point in time, the TCP connection has been established and the client can send and receive data, if desired. The takeaway from this action, however, is that the port is open.

﻿

5. Select CTRL+C to close the connection.

﻿

At times, the CDA may want to scan multiple ports at once. This is where the -z option comes in handy. -z indicates that Netcat sends zero data; it simply establishes the TCP handshake, and closes the connection automatically, if it can be established. This is preferable to the alternative of selecting CTRL+C after every port.

﻿

The nc command also takes multiple ports or port ranges to check various services on a host. For example, the following are valid syntaxes:

nc -nvz 8.8.8.8 20-25       #Scans ports 20, 21, 22, 23, 24, and 25
nc -nvz 8.8.8.8 22 23 80    #Scans ports 22, 23, and 80
nc -nvz 8.8.8.8 20-25 80    #Scans ports 20, 21, 21, 23, 24, 25, and 80
﻿

6. Run the following command to test if Secure Shell (SSH), TELNET, Simple Mail Transfer Protocol (SMTP), HTTP, HTTP Secure (HTTPS), and Post Office Protocol 3 (POP3) are open:

(trainee@dmss-kali)-[~] $ nc -nvz -w 10 172.35.1.21 22 23 25 80 443 110
﻿

In this case, the host being scanned is the core router in the range network.

NOTE: Netcat only prints outputs for ports that are open. All output can be seen by running the following command:

(trainee@dmss-kali)-[~] $ for port in 22 23 25 80 443 110; do nc -nvz -w 10 172.35.1.21 $port; done

Port Scanning and Banner Grabbing with Netcat
The resulting output from the previous command is shown below:

As detailed, SSH is open on this device. Now that the open port is verified, perform a banner grab to get more information on the service.

NOTE: The following steps continue from the previous task.

7. Run the nc command without the -z option on the open port to perform a banner grab:

(trainee@dmss-kali)-[~] $ nc -nvw 10 172.35.1.21 22
﻿
Depending on the service running or how the service is configured, the server may not always return a banner or data. This was seen in the first port scan against HTTP; even with the socket left open, the server sent no data. 

Port Scanning and Banner Grabbing with Telnet
From the output, it is evident that the version of SSH on the host is OpenSSH 5.5.

﻿

﻿

Figure 6.2-9

﻿

Recall seeing a -u option for UDP mode with Netcat. This functionality does not work as expected and is not recommended for use as a port scanner. Netcat looks for an ICMP UDP port unreachable to determine if a port is closed. If the port is filtered or open, then the program states the port is open. As it stands, the messages returned from UDP scans are often unreliable and may confuse analysts. If nc must be used to port scan UDP ports, the most surefire way to assess if a port is open is if data is received from the server. This means the -z option is not possible.

﻿

Table 6.2-3 details the UDP Port States and the message received from Netcat:

﻿

﻿

Table 6.2-3

﻿

Telnet is a less versatile tool than Netcat, but the choice of tools is not always available in the environment. For example, many Cisco IOS devices may not have Netcat, but may have Telnet installed.

﻿

Workflow

﻿

NOTE: The following steps continue from the previous task.

﻿

8. Check to see if Telnet is installed on the host:

(trainee@dmss-kali)-[~] $ which telnet
﻿

9. Run the following command to port scan and banner grab with Telnet:

(trainee@dmss-kali)-[~] $ telnet 172.35.1.21 22
﻿

﻿

Figure 6.2-10

﻿

An open port is indicated by the Connected to 172.35.1.21 message. The banner is also displayed. As mentioned before with Netcat, a banner may not be returned based on the service or its configuration.

﻿

10. Select CTRL+C and Enter to close out the connection.

﻿

A closed port message appears as with Netcat. Recall in the previous steps, port 21 on the router was scanned and verified that the service was not running.

﻿

11. Run the following command to attempt to connect to TCP port 21 with Telnet:

(trainee@dmss-kali)-[~] $ telnet 172.35.1.21 21
﻿
Nmap
Nmap is a popular free and open-source utility for network discovery and security auditing. It is a powerful tool that does much more than port scanning; many network and systems administrators use it for vulnerability scanning, network inventory, managing upgrading schedules, and more. Due to its popularity, Nmap is a well-documented utility. There are versions that support Windows, Linux, and macOS. Unlike Netcat however, Nmap does not come preinstalled on most OSs. Nmap also has a few sub-projects such as Ndiff and Zenmap. Ndiff compares two different Nmap scan results and reports differences. Zenmap is a Graphical User Interface (GUI)-based tool that allows the user to create and save scanning profiles.

﻿

There are six NMAP port states according to Nmap.org documentation:

﻿

Open
﻿

An application is actively accepting TCP connections or UDP packets on this port. Finding these is often the primary goal of port scanning. Security-minded people know that each open port is an avenue for attack. Attackers and pen-testers want to exploit the open ports, while administrators try to close or protect them with firewalls without thwarting legitimate users. Open ports are also interesting for non-security scans because they show services available for use on the network. Before getting too excited about an open port, note that it is possible that the application is protected with a TCP Daemon Wrapper (TCPD) or that the application itself is configured to only service approved client IP addresses. Such cases still leave more attack surface than a closed port.

﻿

Closed
﻿

A closed port is accessible (it receives and responds to Nmap probe packets), but there is no application listening on it. They can be helpful in showing that a host is online and using an IP address — host discovery or ping scanning — and as part of OS detection. Because closed ports are reachable, they may be worth scanning later in case some open up. Administrators may want to consider blocking such ports with a firewall so they appear in the filtered state.

﻿

Filtered
﻿

Nmap cannot determine whether the port is open because packet filtering prevents its probes from reaching the port. The filtering could be from a dedicated firewall device, router rules, or host-based firewall software. These ports frustrate attackers because they provide so little information. Sometimes they respond with ICMP error messages such as type 3 code 13 — destination unreachable: communication administratively prohibited — however, filters that simply drop probes without responding are far more common. This forces Nmap to retry several times in case the probe was dropped due to network congestion rather than filtering. This sort of filtering slows scans down dramatically.

﻿

Unfiltered
﻿

The unfiltered state means that a port is accessible, but Nmap is unable to determine whether it is open or closed. Only the ACK scan, which is used to map firewall rulesets, classifies ports into this state. Scanning unfiltered ports with other scan types such as Window scan, SYN scan, or FIN scan, may help resolve whether the port is open.

﻿

Open|Filtered
﻿

Nmap places ports in this state when it is unable to determine whether a port is open or filtered. This occurs for scan types in which open ports give no response. The lack of response could also mean that a packet filter dropped the probe or any response it elicited. So Nmap does not know for sure whether the port is open or being filtered. The UDP, IP protocol, FIN, NULL, and Xmas scans classify ports this way.

﻿

Closed|Filtered
﻿

This state is used when Nmap is unable to determine whether a port is closed or filtered. It is only used for the IP Identification (ID) Idle scan discussed in the TCP Idle Scan (-sI) section.

﻿

Workflow

﻿

1. Log in to the kali-hunt VM using the following credentials:

Username: trainee
Password: CyberTraining1!
﻿

At a minimum, Nmap only needs a host to run.

﻿

2. Run the following command to conduct a Nmap scan against a host.

(trainee@dmss-kali)-[~] $ nmap 172.35.3.6
﻿

﻿

Figure 6.2-12

﻿

This conducts host discovery to ensure that the host is up, and conducts a scan of the 1,000 most popular TCP ports.

﻿

By default, Nmap conducts host discovery before commencing the port scan. With multiple hosts, this saves time by ensuring that a host is there before blasting thousands of packets. Nmap's default host discovery uses four packets: an ICMP echo request, a TCP probe to 80 and 443, and an ICMP Timestamp request. If the user has superuser privileges, the TCP probes are a TCP ACK to port 80 and TCP SYN to port 443. If the user only has regular user privileges, then the TCP probes are both SYN packets. However, many hosts have ICMP disabled and/or firewall rules in place so the default scan many not give the user the best results depending on the circumstances. While Nmap's host discovery can be tailored to better fit the environment, this is not covered in this lesson. To skip host discovery, for reasons such as the host is known to be up or due to the target environment configuration, use the option -Pn. For example, the following command implements skipping host discovery: 

(trainee@dmss-kali)-[~] $ nmap -Pn 8.8.8.8
﻿

NOTE: Superuser privileges are required whenever crafting raw packets as it requires lower level access, e.g., a stray ACK in the case of Nmap's host discovery.

﻿

Depending on the user privileges, the scan is a TCP SYN Stealth scan as a superuser or a TCP Connect scan as a regular user. A TCP SYN Stealth scan sends a SYN, and if it receives a SYN/ACK, it replies with a RST; it never completes a full connection. This is less likely to create logs, as many applications only create logs after a connection has been established. The switch for a TCP SYN Stealth scan is -sS.

(trainee@dmss-kali)-[~] $ nmap -sS 8.8.8.8  #Must be run as root or with sudo 
﻿

A TCP Connect scan completes the TCP handshake, then closes the connection. No special privileges are required to run this type of scan. The switch for a Full Connect scan is -sT. The following Nmap command is an example of a TCP Connect scan:

(trainee@dmss-kali)-[~] $ nmap -sT 8.8.8.8
﻿

Nmap also allows the user to specify ports, if desired, with the -p option. Listed below are some examples of valid syntax with the -p option:

nmap -sS 8.8.8.8 -p 22			#Scan port 22
nmap -sS 8.8.8.8 -p 1-100		#Scan ports 1-100
nmap -sS 8.8.8.8 -p 5,6,7,8,9	#Scan ports 5,6,7,8,9
nmap -sS 8.8.8.8 -p-			#Scan all 65,535 ports
nmap -sS 8.8.8.8 -p-25			#Scan all ports up to 25
nmap -sS 8.8.8.8 -p65530-		#Scan all ports above port 65530
﻿
Service and OS Versioning
Nmap has a few options that allow for service, version, and OS identification. They are as follows:

-sV: Enables service and version detection. This is done by sending out a series of probes that elicit information.

-O: Enables OS detection. Nmap provides a best guess of what the underlying OS is based on TCP/IP Stack fingerprinting. Different OSs generally have different options set in their TCP/IP options which enables OS detection.

NOTE: Both operations are very noisy and are likely to set off Intrusion Detection System (IDS) alerts.

3. In the kali-hunt VM, run the following command to enable service, version and OS detection on a host. The host in this command is the DNS server for the range network. The sudo command prompts for a password — CyberTraining1!

(trainee@dmss-kali)-[~] $ sudo nmap -sS -sV -O -Pn 172.35.3.2     

Based on the results of the service version and OS detection, attempt to correlate publicly or privately known exploits to gain access. For example, since the DNS service was detected as Simple DNS Plus, use open-source research to determine if there are known exploits against that service. Finding exploits is covered in a future module.
Circumventing Firewalls
Depending on the network, port scans may not give the best results due to network or host firewalls. Nmap has a few different TCP modes to attempt circumventing firewalls. Keep in mind that this generally only works with stateless firewalls; a common stateless firewall configuration is dropping SYN packets from external networks to prevent new connections from the outside. The scan types are as follows:

-sA ACK Scan: Set only the ACK flag. This scan is used in particular to check whether a firewall is stateful or not. It is unable to detect if a port is open or closed.

-sW Window Scan: Same as the ACK Scan, however, it attempts to use Window Size to make a determination on port size. A minority of OSs have a positive Window Size in the RST response packet if the port is open. If closed, the system responds with a RST with a Window Size of 0.

-sF FIN Scan: Set only the FIN flag. This may be able to detect if a port is open as no response from a host is indicative of an open port and a RST is indicative of the port being closed.

-sN NULL Scan: No TCP flags are set. This may be able to detect if a port is open as no response from a host is indicative of an open port and a RST is indicative of the port being closed.

-sX Xmas Scan: The FIN, Push (PSH) and Urgent (URG) flags are all set. This may be able to detect if a port is open as no response from a host is indicative of an open port and a RST is indicative of the port being closed.

-sM Maimon Scan: Sets the FIN and ACK flags. This may be able to detect if a port is open as no response from a host is indicative of an open port and a RST is indicative of the port being closed.

--scanflags (CWR|ECE|URG|ACK|PSH|RST|SYN|FIN) Even more granularity on which flags are set can be done with the --scanflags option.

NOTE: These are not standard TCP packets; running these scans requires superuser privileges.

﻿

These scans work in theory because Request for Comments (RFC) 793 states that hosts are supposed to respond to packets with these flags set outside of an established connection with a RST. Using this information, a host that does not respond is determined to be open|filtered and a host that responds with a RST is closed. However, many OSs do not conform to the RFC so there is no one-size-fits-all. The firewall configuration and the way the host responds depends on the OS. Some experimentation may be required to get better results with these scans. As the tactics of Malicious Cyber Actors (MCA) become known, these scans become less successful, especially in modern OSs.


4. Start a packet capture to observe the traffic being sent to the host to scan. The host in this case is 172.35.3.6, which is a web server within the range network.

(trainee@dmss-kali)-[~] $ sudo tcpdump -i eth1 -nnn 'host 172.35.3.7'
﻿
5. In a new window, run the following command to initiate a SYN Stealth scan against a web server host in the range network.

(trainee@dmss-kali)-[~] $ sudo nmap -sS -Pn 172.35.3.7
﻿
The packets can be seen leaving the kali host.

However, when the scan completes, it appears as if there is a firewall along the path to the device that is filtering traffic. Observe the packet capture. No response is ever generated from the host being scanned, so Nmap assumes that the host is filtered. Note that with the -Pn option, Nmap assumes a host is filtered if the host is not up.

6. Run an ACK Scan to check if the firewall is stateless. To save time, only one port is scanned, which in this case, is 22.

(trainee@dmss-kali)-[~] $ sudo nmap -sA -Pn -p 22 172.35.3.7
﻿

Nmap reports this port as unfiltered. Observing the packet capture in the other window, it becomes evident why. This time, an RST response is received from the host.

When a stateless firewall is found, the analyst can typically proceed with the other scans (i.e., NULL, FIN, XMAS). However, due to the underlying OSs within the range environment, the scans do not report accurate port state information. This is very common, as many modern OSs do not respond at all to these scans. 

﻿

7. Select CTRL+C to stop the tcpdump capture.

UDP Scan
Nmap has UDP scanning capabilities as well and requires superuser privileges to run. The -sU option denotes a UDP scan, and can be done in conjunction with other TCP scans.

NOTE: The following steps continue from the previous task.

8. The host to investigate is a DNS server for the range network. Run the following command to scan the top 1,000 UDP ports:

(trainee@dmss-kali)-[~] $ sudo nmap -Pn -sU 172.35.3.2
﻿
From the scan results, it appears that UDP port 53 is open, which corresponds to the DNS service.

NOTE: Nmap reports 999 other ports as open|filtered. Recall that this is due to UDP services not having a handshake as TCP services does, and is much more difficult to get a definitive state for.

Nmap Operational Security
Port scanning involves hundreds, if not thousands, of packets depending on the scan options. IDSs and Intrusion Prevention Systems (IPS) easily pick up on this activity. Nmap comes with timing templates, which enable the penetration tester to reduce the odds of being caught. These range from the T0 option, which is the least likely to set off alerts, to T5, which is an extremely loud packet blaster. The TCP options set for each template can be seen in Table 6.2-4. Do not memorize this table, it simply gives some insight on what is done differently from T0 to T5.

﻿

﻿

Table 6.2-4

﻿

NOTE: Timing parameters in Table 6.2-4 are shown in milliseconds.

﻿

The author of the documentation states that if you have a decent broadband connection and are not worried about setting off an IDS/IPS, then T4 is a good template to use. Keep in mind that the templates on the lower end take more time to complete as they wait more time before sending out more packets, as seen by the scan delay. For example, the T2 template can take more than ten times longer than the T4 template.


9. Run the following command to run a port scan for the range 20-25 with the aggressive timing template. This gives some idea of the time it takes to complete the scan.

(trainee@dmss-kali)-[~] $ sudo nmap -sS -Pn -T4 -p 20-25 172.35.3.1
﻿
The scan completes in 13.31 seconds for six ports on one host. Runtimes may differ slightly. 

﻿

10. Run the same command, only with the sneaky timing template (T1).

(trainee@dmss-kali)-[~] $ sudo nmap -sS -Pn -T1 -p 20-25 172.35.3.1
﻿

This may take a few minutes to run.

Note the time difference between the two: 13 seconds versus just under two minutes for just six ports. If detection is not a concern, then finishing port scans quickly is ideal. However, based on the presence and configuration of security systems within the network, it may be necessary to take more time to scan the network to prevent tipping of IDSs/IPSs.

﻿Port Scanning Recap
The takeaway is that there are a few different port scanning utilities available to CDAs. The three covered are Netcat, Telnet, and Nmap. Some options that may come in handy for a CDA are as follows:

﻿

Netcat
-n: Disable port and name resolution
-v: Verbose
-w: Wait timeout
-z: Zero data
Nmap
-p: Port specification
-Pn: Do not conduct host discovery
-sS: SYN Stealth
-sT: Connect
-sA: ACK scan
-sW: Window scan
-sF: FIN scan
-sN: Null scan
-sX: Xmas scan
-sM: Maimon scan
-sU: UDP scan
-T[0-5]: Timing template
-sV: Attempt service and version detection
-O: Detect the OS
From the defensive perspective, hosting services leave open ports on a system. These open ports increase the attack surface within the network and may enable adversaries to gain footholds within their targeted network. Disabling an unneeded service reduces the attack surface. Firewall devices may also protect against scanning attempts if a service is needed, though it may be possible to circumvent them. Test and validate firewall rules for the best mitigative results.

Vulnerability Scanning
Vulnerability scans oftentimes follow port scans. For example, when a host is scanned and port 80 is determined to be up, the CDA might run Nikto, an open-source vulnerability scanner for assessing web servers. However, this is not always the case. Vulnerability scanners have become much more robust and may even incorporate port scanners. Vulnerability scanners — such as Assured Compliance Assessment Solution (ACAS) — are made to be more comprehensive. Vulnerability scanners fall underneath the reconnaissance tactic of MITRE ATT&CK under the technique ID T1595.002. The results of a vulnerability scanner may include the following:

Unwanted services running.
Default credentials in use.
Out-of-date software in need of hotfixes, patches, or updates.
Weak algorithm usage.
Insecure configurations.
Existing exploits for software.
Adversaries may use vulnerability scanners to delve into a host's weaknesses and find room for exploitation. Network defenders use vulnerability scanners to assess their network and locate mitigations that should be applied. Some services, such as web, are incredibly complex with a seemingly infinite number of configurations, software backends, etc. Vulnerability scanners dedicated to just scanning web services exist.

﻿

Vulnerability scans can be unauthenticated or authenticated. Unauthenticated scans pass no additional information to the scanner for a provided service. Authenticated scans provide information needed to log into services to gather configuration settings and assess a service more in-depth — past just the login page. Both have their uses; unauthenticated scans allow a CDA to see results as adversaries would see them, while authenticated scans enable the defender to gather more vulnerability information about a service. Both authenticated and unauthenticated scans should be evaluated for a complete picture.

﻿

Vulnerability scanners include the following:

ACAS: Also known as Nessus. ACAS is frequently used by CPTs and likely encountered as a CDA.
Nmap: Mentioned as a port scanner; however, it can function as a vulnerability scanner, especially with the Network Scripting Engine (NSE).
OpenVAS: Another full-featured vulnerability scanner.
Nikto: An open-source web vulnerability scanner. It specializes in finding web-based attacks such as Structured Query Language (SQL) injection and Cross-Site Scripting (XSS) vulnerabilities.
Burp Suite: Another web vulnerability scanner.
ACAS, Nmap NSE, and Nikto are covered more deeply in the following lab.

Nikto
Nikto is a one-trick pony, but it does its one trick well. Nikto only scans web services, but it is a fantastic tool to use when encountering a web server. It is easy to install, easy to use, and capable of a fairly comprehensive scan in a relatively short amount of time. It is capable of identifying several vulnerabilities in the Open Web Application Security Project (OWASP) Top 10 such as security misconfiguration, cross site scripting, and injection.

﻿

Workflow

﻿

NOTE: The following steps continue from the previous task.

﻿

15. Run the following command to scan a web server within the range environment with Nikto:

(trainee@dmss-kali)-[~] $ nikto -h 172.35.3.6
﻿

The -h specifies the host.

﻿

﻿

Figure 6.2-41

﻿

The output from the scan is as explained:

﻿

Nikto was able to identify the version of the web server, which was Nginx 1.14.0 as per the first bullet. Nikto was also able to identify issues that may lead to clickjacking and XSS, as well as a potential rendering issue that may occur on web browsers from the following three bullets. Clickjacking is when an attacker uses transparent or opaque layers over the actual content of the page to cause a user to click on the attacker's link and sends the user to a malicious page. The clickjacking issue was discovered due to a lack of the X-Frame-Options header, as referenced by the second bullet in the output. The XSS issue comes from an absent X-XSS-Protection header, as evidenced by the third bullet. The potential rendering issue is also the result of a missing header, the X-Content-Type-Options header as per the fourth bullet.

﻿

The scan took 2 minutes and 36 seconds, which is reasonably short.

Detecting Adversaries Using Timing Templates
The trainee can tell it was a SYN Stealth because the maximum client packets was 2. This is indicative of a SYN and a RST. Figure 6.2-51 details one of the entries expanded, which alludes to this:

﻿

﻿

Figure 6.2-51

﻿

Recall that Nmap has built-in timing templates that try to mask scanning attempts. In the following steps, observe a timing template of 0, also known as the paranoid timing template.

﻿

Workflow

﻿

NOTE: The following steps continue from the previous task.

﻿

11. Clear the current search and set the time range to October 12th, 2021 14:30 - October 12th, 2021 16:00. The columns toggled in the previous steps should still be set.

﻿

﻿

Figure 6.2-52

﻿

12. Run the following query to filter for only Zeek connection logs.

event.dataset:conn
﻿

﻿

Figure 6.2-53

﻿

The scans are not nearly as obvious now. Recall that in the previous scan, there was a single large spike, but is not immediately noticeable here. The -T0 option was used to run this scan, which is why it blends in with the traffic much better. Luckily, there are a few methods of detecting these scans. The first method that was examined uses the behavioral characteristics of Nmap scans that were examined in previous steps. This time, search for packets generated by open AND closed ports. The purpose of this is to identify any potential port scanning behavior at all. A few port probes may be normal, but a large range of ports scanned by the same host appears more suspicious.

﻿

13. Run the following query to search for scanning behavior:

event.dataset:conn and source.ip:199.63.64.51 and ((client.packets>=1 and client.packets<=3) and server.packets<=1)
﻿

Now, the scanning becomes more apparent. 

﻿

﻿

Figure 6.2-54

﻿

Scrolling through the results, there is a wide range of ports and short sessions, which points towards a port scanning attempt.

﻿

There are a few sessions with three client packets despite all being SYN packets. For all intents and purposes, they should be interpreted as their own connection.

﻿

The second detection method covered in this lesson uses Nmap's TCP options. Recall that Nmap uses TCP options to identify host OSs. Ironically, Nmap can be identified via its TCP options as well, namely its TCP Window Size. Nmap sets a default window size of 1024, which is not a typical window size. Typically, OSs have the maximum window size set, not including the scaling factor in the TCP options. This makes identification easier, as a scan can be detected in as little as a single packet. Currently, there is not an easy way to set the TCP Window Size using the Nmap utility itself without recompiling the program. Use the Suricata event module to identify Nmap scans.

﻿

14. Run the following query to filter for Suricata events:

event.module:suricata and message:NMAP
﻿

15. Toggle the following fields:

rule.name

message


As the rule.name and message fields state, a possible NMAP scan was detected. The rule used simply matches on window size, with the threshold to generate an alert being 5 packets in 60 seconds, which is why the graph does not exactly match up with the previous query.

Detecting Nikto Scans
Examine what Nikto scans look like in traffic.

﻿

Workflow

﻿

NOTE: The following steps continue from the previous task.

﻿

19. Set the time range to the following: October 12, 2021 16:30 - October 12, 2021 17:00

﻿

Unlike the other scans examined, Nikto scans are most prominent in Zeek HTTP Logs.

﻿

20. Filter for HTTP logs by running the following query:

event.dataset:http
﻿

﻿

Figure 6.2-61

﻿

Like the other scans, Nikto is marked by a significant uptick in traffic.

﻿

21. Select the highest peak which starts at 16:57.

﻿

22. Toggle the following fields:

source.ip

destination.ip

http.status_code

http.uri

http.request.body.length

http.response.body.length

﻿

Figure 6.2-62

﻿

Upon first glance, several HTTP 301s can be seen from 199.63.64.51. There are a few HTTP 404s that can be seen but may not come from 199.63.64.51.

﻿

﻿

Figure 6.2-63

﻿

If the source IP address was not known, then it is found by selecting the highest spike. However, this view is not much more useful as there is not much to glean, other than the excess of HTTP 301s.

﻿

23. Return the time range to October 12, 2021 16:30 - October 12, 2021 17:00, and run the following query to filter out web connections from different hosts:

event.dataset:http and source.ip:199.63.64.51
﻿

﻿

Figure 6.2-64

﻿

After filtering for 199.63.64.51, much more spookiness is seen. First, notice the user agent string Mozilla/5.00 (Nikto/2.1.6) (Evasions:None) (Test:007239), which not only stands out, but lets the user know exactly what program is running the vulnerability scan. While script kiddies may not know to change the user agent value, it is trivial to do so by changing the user agent string in the config file.

﻿

Because of this, relying on the user agent to identify Nikto is not always reliable. However, the behavior is used to more consistently identify scanning attempts. Note the http.uri field. Nikto attempts to brute force several config files, security-related files, account files, database files, etc. This is not normal user behavior and can be marked as related to scanning activity. A signature that could catch this might trigger an alert if three or more different Uniform Resource Identifiers (URI) from the results are requested. Nikto has built-in evasion techniques to attempt circumvention.

﻿

24. Set the time range to October 12, 2021 17:00 - October 12, 2021 17:30. Do not clear the current query or any fields.

﻿

﻿

Figure 6.2-65

﻿

This Nikto scan used an IDS evasion technique. Scrolling through the results, it is evident that some URIs are using Uniform Resource Locator (URL) encoding, which may circumvent some signatures. URL encoding enables characters outside of the ascii range and special characters. URL uses the percent sign (%) and hexadecimal to encode characters, e.g. a space is encoded as %20. to be transmitted over the Internet. In the data, we can see a %27, which is the ' character encoded. Nikto does not have a timing option, however, and abnormal traffic patterns such as spikes can trigger alerts if the evasion techniques avoid signatures.

Detecting ACAS
The scanning host is 199.63.64.104 as seen in the source.ip column. Notice that in this case, the connections have more packets than during a port scan. The last entry in this screenshot has 24 client packets and 42 server packets. This is because the scanning host actually connects to the server AND sends and receives data to attempt to identify services and vulnerabilities.

﻿

﻿

Figure 6.2-60

﻿

A bonus is that ACAS also employs the user agent string Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0) when scanning web-based ports.

﻿

To summarize, a vulnerability scanner is generally preceded by a port scan but also has longer sessions due to actually sending and receiving data to the server to identify vulnerabilities.

﻿

ACAS does not necessarily have IDS evasion built in. ACAS does, however, have a low-bandwidth mode, which enables slower scans and makes them less detectable. This function is meant to be used over links with less throughput and reduces the number of hosts scanned at a time. Also, low-bandwidth mode slows down the scan if network congestion is detected. However, scans using low-bandwidth mode are still fairly obvious, though this may vary depending on the amount of network traffic. 






